#!/bin/bash
# postinst script for cattywampus
# This script runs after the package is installed

set -e

# Source debconf library
. /usr/share/debconf/confmodule

case "$1" in
    configure)
        echo "Setting up cattywampus user environment..."
        
        # Install missing Python dependencies that aren't available as system packages
        echo "Installing Python dependencies..."
        python3 -m pip install --break-system-packages langcodes>=3.3.0 2>/dev/null || {
            echo "Warning: Could not install langcodes dependency."
            echo "You may need to run: python3 -m pip install --user langcodes>=3.3.0"
        }
        
        # Get list of all users with home directories (excluding system users)
        USER_LIST=$(getent passwd | awk -F: '$3 >= 1000 && $3 != 65534 { print $1 ":" $6 }')
        
        # Set up configuration for each user
        while IFS= read -r user_info; do
            if [ -n "$user_info" ]; then
                username=$(echo "$user_info" | cut -d: -f1)
                home_dir=$(echo "$user_info" | cut -d: -f2)
                
                # Skip if home directory doesn't exist
                if [ ! -d "$home_dir" ]; then
                    continue
                fi
                
                # Create user-specific application directories
                app_config_dir="$home_dir/.local/share/cattywampus"
                config_file="$app_config_dir/config.toml"
                log_file="$app_config_dir/cattywampus.log"
                
                # Create app directory if it doesn't exist
                if [ ! -d "$app_config_dir" ]; then
                    echo "Creating app directory for user $username: $app_config_dir"
                    sudo -u "$username" mkdir -p "$app_config_dir"
                fi
                
                # Copy config file if it doesn't exist
                if [ ! -f "$config_file" ]; then
                    echo "Creating config file for user $username: $config_file"
                    sudo -u "$username" cp /usr/share/cattywampus/config.example.toml "$config_file"
                fi
                
                # Create empty log file if it doesn't exist
                if [ ! -f "$log_file" ]; then
                    echo "Creating log file for user $username: $log_file"
                    sudo -u "$username" touch "$log_file"
                fi
                
                # Ensure proper permissions
                sudo -u "$username" chmod 755 "$app_config_dir"
                sudo -u "$username" chmod 644 "$config_file" 2>/dev/null || true
                sudo -u "$username" chmod 644 "$log_file" 2>/dev/null || true
            fi
        done <<< "$USER_LIST"
        
        echo "cattywampus installation completed successfully!"
        echo "The 'cattywampus' command is now available in your PATH."
        echo ""
        echo "Configuration files have been set up in ~/.local/share/cattywampus/"
        echo "for all existing users with home directories."
        echo ""
        echo "External dependencies required:"
        echo "  - mkvtoolnix (for MKV files) - should be installed automatically"
        echo "  - atomicparsley (for MP4/M4V files) - should be installed automatically"
        echo ""
        echo "Run 'cattywampus --help' to get started!"
        ;;
        
    abort-upgrade|abort-remove|abort-deconfigure)
        ;;
        
    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
        ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0